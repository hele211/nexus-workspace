"""
Experiment schema definitions.

Defines the data models for experiments including:
- Experiment: Main experiment model with status, protocol link, reagent usages
- ReagentUsage: Tracks reagent consumption per experiment
- ExperimentPlan: Structured plan from literature + protocol search
"""

from datetime import datetime
from typing import Any, Dict, List, Literal, Optional

from pydantic import BaseModel, Field


class ReagentUsage(BaseModel):
    """Tracks reagent usage within an experiment."""
    
    reagent_id: str = Field(..., description="ID of the reagent used")
    amount: float = Field(..., description="Amount used")
    unit: str = Field(..., description="Unit of measurement (e.g., µL, mL, mg)")
    source: Literal["manual", "auto_from_protocol"] = Field(
        default="manual",
        description="How this usage was recorded"
    )
    
    model_config = {
        "json_schema_extra": {
            "example": {
                "reagent_id": "reagent_abc123",
                "amount": 5.0,
                "unit": "µL",
                "source": "manual"
            }
        }
    }


class Experiment(BaseModel):
    """
    Main experiment model.
    
    Represents a scientific experiment with links to protocols,
    reagent usage tracking, and optional blockchain provenance.
    """
    
    id: str = Field(..., description="Unique experiment identifier")
    title: str = Field(..., description="Experiment title")
    scientific_question: str = Field(..., description="The scientific question being investigated")
    description: str = Field(..., description="Detailed experiment description")
    status: Literal["planned", "in_progress", "completed"] = Field(
        default="planned",
        description="Current experiment status"
    )
    protocol_id: Optional[str] = Field(
        default=None,
        description="ID of the linked protocol"
    )
    reagent_usages: List[ReagentUsage] = Field(
        default_factory=list,
        description="List of reagent usages in this experiment"
    )
    tags: List[str] = Field(
        default_factory=list,
        description="Tags for categorization"
    )
    notes: Optional[str] = Field(
        default=None,
        description="Additional notes"
    )
    results_summary: Optional[str] = Field(
        default=None,
        description="Summary of experiment results"
    )
    blockchain_tx_hash: Optional[str] = Field(
        default=None,
        description="Transaction hash if stored on blockchain"
    )
    created_at: str = Field(..., description="Creation timestamp (ISO format)")
    updated_at: str = Field(..., description="Last update timestamp (ISO format)")
    
    model_config = {
        "json_schema_extra": {
            "example": {
                "id": "exp_abc123",
                "title": "CRISPR knockout of Gene X",
                "scientific_question": "Does Gene X regulate Y in mouse brain?",
                "description": "Using CRISPR-Cas9 to knockout Gene X and measure Y expression",
                "status": "in_progress",
                "protocol_id": "protocol_xyz789",
                "reagent_usages": [
                    {"reagent_id": "reagent_001", "amount": 5.0, "unit": "µL", "source": "manual"}
                ],
                "tags": ["CRISPR", "mouse", "neuroscience"],
                "notes": "Using N=6 mice per group",
                "results_summary": None,
                "blockchain_tx_hash": None,
                "created_at": "2024-01-15T10:30:00",
                "updated_at": "2024-01-15T10:30:00"
            }
        }
    }


class ExperimentPlan(BaseModel):
    """
    Structured experiment plan from literature and protocol search.
    
    Generated by PlanExperimentWithLiteratureTool.
    """
    
    scientific_question: str = Field(..., description="The question being addressed")
    literature_rationale: str = Field(..., description="Brief rationale based on literature")
    key_papers: List[Dict[str, Any]] = Field(
        default_factory=list,
        description="Key papers supporting the approach"
    )
    suggested_protocols: List[Dict[str, Any]] = Field(
        default_factory=list,
        description="Candidate protocols for the experiment"
    )
    key_considerations: List[str] = Field(
        default_factory=list,
        description="Important considerations and controls"
    )
    
    model_config = {
        "json_schema_extra": {
            "example": {
                "scientific_question": "Does Gene X regulate Y in mouse brain?",
                "literature_rationale": "Previous studies suggest Gene X is expressed in neurons...",
                "key_papers": [
                    {"title": "Gene X in neural development", "doi": "10.1234/example"}
                ],
                "suggested_protocols": [
                    {"id": "protocol_123", "name": "CRISPR knockout protocol"}
                ],
                "key_considerations": [
                    "Include wild-type controls",
                    "Consider off-target effects"
                ]
            }
        }
    }


# Export all schemas
__all__ = [
    "ReagentUsage",
    "Experiment",
    "ExperimentPlan",
]
